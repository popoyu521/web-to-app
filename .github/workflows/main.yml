name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Setup Android SDK
      run: |
        # 下载并安装 Android SDK 命令行工具
        SDK_VERSION="11076708"
        SDK_ZIP="commandlinetools-linux-${SDK_VERSION}_latest.zip"
        SDK_URL="https://dl.google.com/android/repository/${SDK_ZIP}"
        
        echo "Downloading Android SDK from: $SDK_URL"
        wget -q "$SDK_URL" -O cmdline-tools.zip
        
        echo "Extracting Android SDK..."
        mkdir -p $HOME/android-sdk
        unzip -q cmdline-tools.zip -d $HOME/android-sdk
        rm cmdline-tools.zip
        
        # 重命名目录以符合预期结构
        mv $HOME/android-sdk/cmdline-tools $HOME/android-sdk/cmdline-tools-latest
        mkdir -p $HOME/android-sdk/cmdline-tools
        mv $HOME/android-sdk/cmdline-tools-latest $HOME/android-sdk/cmdline-tools
        
        # 设置环境变量
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "PATH=$HOME/android-sdk/cmdline-tools/latest/bin:$PATH" >> $GITHUB_ENV

    - name: Accept Android licenses
      run: |
        # 创建 repositories.cfg 文件以避免警告
        mkdir -p $HOME/.android
        touch $HOME/.android/repositories.cfg
        
        # 接受所有许可证
        yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true

    - name: Install Android components
      run: |
        # 安装必要的 Android 组件
        $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-33" \
          "build-tools;33.0.0" \
          "extras;android;m2repository" \
          "extras;google;m2repository"

    - name: Display project structure
      run: |
        echo "=== Project Structure ==="
        pwd
        ls -la
        
        echo ""
        echo "=== Gradle files ==="
        find . -name "*.gradle*" -type f | head -10
        
        echo ""
        echo "=== Checking for gradlew ==="
        if [ -f "gradlew" ]; then
          echo "gradlew found!"
          chmod +x gradlew
          ./gradlew --version || echo "gradlew --version failed"
        else
          echo "gradlew not found, will use gradle directly"
        fi

    - name: Build APK
      run: |
        echo "=== Starting build ==="
        
        # 检查并设置可执行权限
        if [ -f "gradlew" ]; then
          chmod +x gradlew
          echo "Using gradlew wrapper"
          
          # 清理项目
          ./gradlew clean || echo "Clean failed, continuing anyway"
          
          # 尝试不同的构建命令
          echo "Trying assembleDebug..."
          ./gradlew assembleDebug --stacktrace || {
            echo "assembleDebug failed, trying assemble..."
            ./gradlew assemble --stacktrace || {
              echo "assemble failed, trying build..."
              ./gradlew build --stacktrace || echo "All build attempts failed"
            }
          }
        else
          echo "gradlew not found, checking if we can use gradle directly"
          if command -v gradle &> /dev/null; then
            echo "Using system gradle"
            gradle clean
            gradle assembleDebug --stacktrace || gradle build --stacktrace
          else
            echo "ERROR: No gradle available"
            exit 1
          fi
        fi

    - name: Find and copy APK files
      run: |
        echo "=== Searching for APK files ==="
        
        # 查找所有 APK 文件
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null)
        
        if [ -z "$APK_FILES" ]; then
          echo "No APK files found, listing build outputs..."
          
          # 查找可能的构建输出目录
          find . -type d -name "outputs" -o -name "build" | while read dir; do
            echo "Checking $dir:"
            ls -la "$dir" 2>/dev/null | head -10 || true
          done
          
          # 尝试查找任何构建产物
          echo "Recent files in build directories:"
          find . -path "*/build/*" -type f -mmin -30 2>/dev/null | head -20 || true
          
          exit 1
        else
          echo "Found APK files:"
          echo "$APK_FILES"
          
          # 创建 artifacts 目录
          mkdir -p artifacts
          
          # 复制所有 APK 文件到 artifacts 目录
          echo "$APK_FILES" | while read apk; do
            echo "Copying $apk to artifacts/"
            cp "$apk" artifacts/
          done
          
          # 显示复制的文件
          echo "Contents of artifacts directory:"
          ls -la artifacts/
        fi

    - name: Upload APK artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: artifacts/*.apk
        if-no-files-found: error
        retention-days: 7

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/build/reports/
          **/build/outputs/
        retention-days: 7
